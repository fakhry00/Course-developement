{% extends "base.html" %}

{% block title %}Review Generated Materials - AI Course Generator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header with Summary -->
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i>Generation Complete!</h4>
                        <p class="mb-0 opacity-75">Review your generated materials and download or regenerate as needed</p>
                    </div>
                    <div class="col-auto">
                        <div class="text-end">
                            <h5 class="mb-0" id="totalFilesCount">{{ total_files }} Files</h5>
                            <small class="opacity-75" id="totalSizeDisplay">{{ total_size }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Bar -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="btn-group me-3" role="group">
                            <button class="btn btn-primary" onclick="downloadAll()">
                                <i class="fas fa-download me-2"></i>Download All
                            </button>
                            <button class="btn btn-outline-primary" onclick="selectiveDownload()">
                                <i class="fas fa-list me-2"></i>Selective Download
                            </button>
                        </div>
                        <button class="btn btn-outline-success me-2" onclick="generateMoreMaterials()">
                            <i class="fas fa-plus me-2"></i>Generate More
                        </button>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                                <i class="fas fa-th"></i> Grid
                            </button>
                            <button class="btn btn-secondary" onclick="toggleView('list')" id="listViewBtn">
                                <i class="fas fa-list"></i> List
                            </button>
                            <button class="btn btn-outline-secondary" onclick="toggleView('tree')" id="treeViewBtn">
                                <i class="fas fa-sitemap"></i> Tree
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter me-2"></i>Filter & Search Materials</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Search Materials</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by name, type, or week..." onkeyup="filterMaterials()">
                            <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Week</label>
                        <select class="form-select" id="weekFilter" onchange="filterMaterials()">
                            <option value="">All Weeks</option>
                            {% for i in range(1, total_weeks + 1) %}
                            <option value="{{ i }}">Week {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Material Type</label>
                        <select class="form-select" id="typeFilter" onchange="filterMaterials()">
                            <option value="">All Types</option>
                            <option value="lecture_notes">Lecture Notes</option>
                            <option value="lecture_slides">Lecture Slides</option>
                            <option value="transcripts">Transcripts</option>
                            <option value="lab_materials">Lab Materials</option>
                            <option value="assessments">Assessments</option>
                            <option value="seminar_materials">Seminar Materials</option>
                            <option value="module_overview">Module Overview</option>
                            <option value="instructor_guide">Instructor Guide</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">File Format</label>
                        <select class="form-select" id="formatFilter" onchange="filterMaterials()">
                            <option value="">All Formats</option>
                            <option value="PDF">PDF</option>
                            <option value="DOCX">Word</option>
                            <option value="PPTX">PowerPoint</option>
                            <option value="TXT">Text</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-outline-warning w-100" onclick="resetFilters()" title="Reset Filters">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="badge bg-info" id="filterResults">Showing all materials</span>
                </div>
            </div>
        </div>

        <!-- Materials Display -->
        <div id="materialsContainer">
            <!-- Grid View -->
            <div id="gridView" class="materials-view">
                <div class="row" id="materialsGrid">
                    <!-- Grid items will be populated by JavaScript -->
                </div>
            </div>

            <!-- List View -->
            <div id="listView" class="materials-view" style="display: none;">
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th width="40%">Material</th>
                                    <th width="10%">Week</th>
                                    <th width="15%">Type</th>
                                    <th width="10%">Format</th>
                                    <th width="10%">Size</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="materialsTable">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tree View -->
            <div id="treeView" class="materials-view" style="display: none;">
                <div id="materialsTree">
                    <!-- Tree structure will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Bulk Actions (shown when items are selected) -->
        <div class="card mt-4" id="bulkActionsCard" style="display: none;">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Bulk Actions <span class="badge bg-primary" id="selectedCount">0 selected</span></h6>
            </div>
            <div class="card-body">
                <button class="btn btn-primary me-2" onclick="bulkDownload()">
                    <i class="fas fa-download me-1"></i>Download Selected
                </button>
                <button class="btn btn-outline-warning me-2" onclick="bulkRegenerate()">
                    <i class="fas fa-sync me-1"></i>Regenerate Selected
                </button>
                <button class="btn btn-outline-danger" onclick="bulkDelete()">
                    <i class="fas fa-trash me-1"></i>Delete Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    <span id="previewTitle">File Preview</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading preview...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="downloadCurrentPreview()">
                    <i class="fas fa-download me-1"></i>Download
                </button>
                <button class="btn btn-outline-warning" onclick="regenerateCurrentPreview()">
                    <i class="fas fa-sync me-1"></i>Regenerate
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Regenerate Confirmation Modal -->
<div class="modal fade" id="regenerateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-sync me-2"></i>Regenerate Material
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to regenerate <strong id="regenerateItemName">this material</strong>?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>What happens:</strong>
                    <ul class="mb-0 mt-2">
                        <li>The current file will be replaced</li>
                        <li>AI will generate new content</li>
                        <li>This action cannot be undone</li>
                        <li>Generation may take a few minutes</li>
                    </ul>
                </div>
                <div class="regeneration-options">
                    <h6>Regeneration Options:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enhanceContent" checked>
                        <label class="form-check-label" for="enhanceContent">
                            Use enhanced prompts for better content
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="keepOriginal">
                        <label class="form-check-label" for="keepOriginal">
                            Keep original as backup (rename with _backup)
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmRegeneration()">
                    <i class="fas fa-sync me-1"></i>Regenerate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Regeneration Progress Modal -->
<div class="modal fade" id="regenerationProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin me-2"></i>Regenerating Material
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="regenerationProgress" style="width: 0%"></div>
                </div>
                <div id="regenerationStatus">Preparing regeneration...</div>
                <div class="mt-3">
                    <small class="text-muted">Material: <span id="regenerationItemName">--</span></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="cancelRegeneration()" id="cancelRegenerationBtn">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden inputs -->
<input type="hidden" id="sessionId" value="{{ session_id }}">
<input type="hidden" id="materialsData" value="{{ materials_json }}">
{% endblock %}

{% block scripts %}
<script>
// Global variables
const sessionId = document.getElementById('sessionId').value;
let materialsData = JSON.parse(document.getElementById('materialsData').value);
let filteredMaterials = [...materialsData];
let selectedItems = new Set();
let currentView = 'grid';
let currentPreviewFile = null;
let regenerationEventSource = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    renderMaterials();
    updateFilterResults();
});

// View Management
function toggleView(viewType) {
    // Update button states
    document.querySelectorAll('[id$="ViewBtn"]').forEach(btn => {
        btn.className = btn.className.replace('btn-secondary', 'btn-outline-secondary');
    });
    document.getElementById(viewType + 'ViewBtn').className = 
        document.getElementById(viewType + 'ViewBtn').className.replace('btn-outline-secondary', 'btn-secondary');
    
    // Hide all views
    document.querySelectorAll('.materials-view').forEach(view => {
        view.style.display = 'none';
    });
    
    // Show selected view
    document.getElementById(viewType + 'View').style.display = 'block';
    currentView = viewType;
    
    // Re-render materials in new view
    renderMaterials();
}

// Materials Rendering
function renderMaterials() {
    switch(currentView) {
        case 'grid':
            renderGridView();
            break;
        case 'list':
            renderListView();
            break;
        case 'tree':
            renderTreeView();
            break;
    }
}

function renderGridView() {
    const container = document.getElementById('materialsGrid');
    container.innerHTML = '';
    
    filteredMaterials.forEach(material => {
        const gridItem = createGridItem(material);
        container.appendChild(gridItem);
    });
}

function createGridItem(material) {
    const col = document.createElement('div');
    col.className = 'col-xl-3 col-lg-4 col-md-6 mb-4';
    
    const isSelected = selectedItems.has(material.id);
    const statusClass = getStatusClass(material.status);
    
    col.innerHTML = `
        <div class="card material-card h-100 ${isSelected ? 'border-primary' : ''}" data-material-id="${material.id}">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" value="${material.id}" 
                           ${isSelected ? 'checked' : ''} onchange="toggleSelection('${material.id}')">
                </div>
                <div class="material-status">
                    <span class="badge ${statusClass}">${material.status}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="file-icon text-center mb-3">
                    <i class="${getFileIcon(material.format)} fa-3x ${getFileIconColor(material.format)}"></i>
                </div>
                <h6 class="card-title" title="${material.name}">${truncateText(material.name, 50)}</h6>
                <div class="material-meta mb-3">
                    <small class="text-muted d-block">
                        <i class="fas fa-calendar me-1"></i>Week ${material.week}
                    </small>
                    <small class="text-muted d-block">
                        <i class="fas fa-tag me-1"></i>${formatMaterialType(material.type)}
                    </small>
                    <small class="text-muted d-block">
                        <i class="fas fa-file me-1"></i>${material.format} • ${formatFileSize(material.size)}
                    </small>
                    <small class="text-muted d-block">
                        <i class="fas fa-clock me-1"></i>${formatDate(material.generated_at)}
                    </small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="previewMaterial('${material.id}')" title="Preview">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadMaterial('${material.id}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="regenerateMaterial('${material.id}')" title="Regenerate">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

function renderListView() {
    const tbody = document.getElementById('materialsTable');
    tbody.innerHTML = '';
    
    filteredMaterials.forEach(material => {
        const row = createListRow(material);
        tbody.appendChild(row);
    });
}

function createListRow(material) {
    const tr = document.createElement('tr');
    const isSelected = selectedItems.has(material.id);
    const statusClass = getStatusClass(material.status);
    
    if (isSelected) {
        tr.className = 'table-primary';
    }
    
    tr.innerHTML = `
        <td>
            <input class="form-check-input" type="checkbox" value="${material.id}" 
                   ${isSelected ? 'checked' : ''} onchange="toggleSelection('${material.id}')">
        </td>
        <td>
            <div class="d-flex align-items-center">
                <i class="${getFileIcon(material.format)} fa-lg me-3 ${getFileIconColor(material.format)}"></i>
                <div>
                    <div class="fw-bold">${material.name}</div>
                    <small class="text-muted">${formatDate(material.generated_at)}</small>
                </div>
            </div>
        </td>
        <td><span class="badge bg-primary">Week ${material.week}</span></td>
        <td><span class="badge bg-secondary">${formatMaterialType(material.type)}</span></td>
        <td><span class="badge ${statusClass}">${material.format}</span></td>
        <td>${formatFileSize(material.size)}</td>
        <td>
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" onclick="previewMaterial('${material.id}')" title="Preview">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-primary" onclick="downloadMaterial('${material.id}')" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-outline-warning" onclick="regenerateMaterial('${material.id}')" title="Regenerate">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
        </td>
    `;
    
    return tr;
}

function renderTreeView() {
    const container = document.getElementById('materialsTree');
    container.innerHTML = '';
    
    // Group materials by week and type
    const grouped = groupMaterialsForTree();
    
    Object.keys(grouped).sort().forEach(week => {
        const weekNode = createTreeWeekNode(week, grouped[week]);
        container.appendChild(weekNode);
    });
}

function groupMaterialsForTree() {
    const grouped = {};
    
    filteredMaterials.forEach(material => {
        const weekKey = material.week === 0 ? 'Overview' : `Week ${material.week}`;
        if (!grouped[weekKey]) {
            grouped[weekKey] = {};
        }
        
        const typeKey = formatMaterialType(material.type);
        if (!grouped[weekKey][typeKey]) {
            grouped[weekKey][typeKey] = [];
        }
        
        grouped[weekKey][typeKey].push(material);
    });
    
    return grouped;
}

function createTreeWeekNode(weekTitle, weekMaterials) {
    const weekDiv = document.createElement('div');
    weekDiv.className = 'tree-week mb-3';
    
    const materialsCount = Object.values(weekMaterials).reduce((sum, materials) => sum + materials.length, 0);
    
    weekDiv.innerHTML = `
        <div class="week-header card">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#week-${weekTitle.replace(/\s+/g, '')}" 
                 style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-folder me-2"></i>${weekTitle}
                        <span class="badge bg-primary ms-2">${materialsCount}</span>
                    </h6>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapse show" id="week-${weekTitle.replace(/\s+/g, '')}">
                <div class="card-body">
                    ${Object.keys(weekMaterials).map(type => `
                        <div class="type-group mb-3">
                            <h6 class="text-muted">
                                <i class="${getTypeIcon(type)} me-2"></i>${type}
                                <span class="badge bg-secondary ms-2">${weekMaterials[type].length}</span>
                            </h6>
                            <div class="materials-list ms-3">
                                ${weekMaterials[type].map(material => `
                                    <div class="material-item d-flex justify-content-between align-items-center py-2 px-3 mb-1 border rounded ${selectedItems.has(material.id) ? 'bg-primary text-white' : 'bg-light'}">
                                        <div class="d-flex align-items-center">
                                            <input class="form-check-input me-3" type="checkbox" value="${material.id}" 
                                                   ${selectedItems.has(material.id) ? 'checked' : ''} onchange="toggleSelection('${material.id}')">
                                            <i class="${getFileIcon(material.format)} me-2"></i>
                                            <span>${material.name}</span>
                                            <span class="badge bg-info ms-2">${material.format}</span>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="previewMaterial('${material.id}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-primary btn-sm" onclick="downloadMaterial('${material.id}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" onclick="regenerateMaterial('${material.id}')">
                                                <i class="fas fa-sync"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    return weekDiv;
}

// Selection Management
function toggleSelection(materialId) {
    if (selectedItems.has(materialId)) {
        selectedItems.delete(materialId);
    } else {
        selectedItems.add(materialId);
    }
    
    updateSelectedItemsUI();
    updateBulkActionsCard();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
    
    selectedItems.clear();
    
    if (selectAll.checked) {
        filteredMaterials.forEach(material => {
            selectedItems.add(material.id);
        });
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedItemsUI();
    updateBulkActionsCard();
}

function updateSelectedItemsUI() {
    // Update individual checkboxes
    document.querySelectorAll('input[type="checkbox"][value]').forEach(checkbox => {
        const materialId = checkbox.value;
        checkbox.checked = selectedItems.has(materialId);
        
        // Update card borders in grid view
        const card = document.querySelector(`[data-material-id="${materialId}"]`);
        if (card) {
            if (selectedItems.has(materialId)) {
                card.classList.add('border-primary');
            } else {
                card.classList.remove('border-primary');
            }
        }
        
        // Update row highlighting in list view
        const row = checkbox.closest('tr');
        if (row) {
            if (selectedItems.has(materialId)) {
                row.classList.add('table-primary');
            } else {
                row.classList.remove('table-primary');
            }
        }
    });
    
    // Update select all checkbox
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
        selectAll.checked = selectedItems.size === filteredMaterials.length && filteredMaterials.length > 0;
        selectAll.indeterminate = selectedItems.size > 0 && selectedItems.size < filteredMaterials.length;
    }
}

function updateBulkActionsCard() {
    const card = document.getElementById('bulkActionsCard');
    const count = document.getElementById('selectedCount');
    
    if (selectedItems.size > 0) {
        card.style.display = 'block';
        count.textContent = `${selectedItems.size} selected`;
    } else {
        card.style.display = 'none';
    }
}

// Filtering and Search
function filterMaterials() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const weekFilter = document.getElementById('weekFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const formatFilter = document.getElementById('formatFilter').value;
    
    filteredMaterials = materialsData.filter(material => {
        const matchesSearch = !searchTerm || 
            material.name.toLowerCase().includes(searchTerm) ||
            material.type.toLowerCase().includes(searchTerm) ||
            material.format.toLowerCase().includes(searchTerm);
        
        const matchesWeek = !weekFilter || material.week.toString() === weekFilter;
        const matchesType = !typeFilter || material.type === typeFilter;
        const matchesFormat = !formatFilter || material.format === formatFilter;
        
        return matchesSearch && matchesWeek && matchesType && matchesFormat;
    });
    
    renderMaterials();
    updateFilterResults();
}

function updateFilterResults() {
    const resultElement = document.getElementById('filterResults');
    const total = materialsData.length;
    const filtered = filteredMaterials.length;
    
    if (filtered === total) {
        resultElement.textContent = `Showing all ${total} materials`;
        resultElement.className = 'badge bg-info';
    } else {
        resultElement.textContent = `Showing ${filtered} of ${total} materials`;
        resultElement.className = 'badge bg-warning';
    }
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('weekFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('formatFilter').value = '';
    
    filterMaterials();
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterMaterials();
}

// Material Actions
async function previewMaterial(materialId) {
    const material = materialsData.find(m => m.id === materialId);
    if (!material) return;
    
    currentPreviewFile = material;
    
    // Update modal title
    document.getElementById('previewTitle').textContent = material.name;
    
    // Show modal with loading state
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    const previewBody = document.getElementById('previewBody');
    
    previewBody.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading preview...</p>
        </div>
    `;
    
    modal.show();
    
    try {
        // Fetch preview content
        const response = await fetch(`/api/preview-file/${sessionId}?file=${encodeURIComponent(material.path)}`);
        
        if (response.ok) {
            const previewData = await response.json();
            displayPreview(previewData, material);
        } else {
            throw new Error('Failed to load preview');
        }
    } catch (error) {
        previewBody.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5>Preview Not Available</h5>
                <p class="text-muted">Unable to preview this file type or content.</p>
                <button class="btn btn-primary" onclick="downloadMaterial('${materialId}')">
                    <i class="fas fa-download me-2"></i>Download Instead
                </button>
            </div>
        `;
    }
}

function displayPreview(previewData, material) {
    const previewBody = document.getElementById('previewBody');
    
    switch (material.format.toLowerCase()) {
        case 'txt':
            previewBody.innerHTML = `
                <div class="preview-content">
                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">${escapeHtml(previewData.content)}</pre>
                </div>
            `;
            break;
            
        case 'pdf':
            previewBody.innerHTML = `
                <div class="preview-content text-center">
                    <embed src="/api/file-content/${sessionId}?file=${encodeURIComponent(material.path)}" 
                           type="application/pdf" width="100%" height="500px" />
                    <p class="mt-2 text-muted">If PDF doesn't display, <a href="#" onclick="downloadMaterial('${material.id}')">download the file</a>.</p>
                </div>
            `;
            break;
            
        case 'docx':
            previewBody.innerHTML = `
                <div class="preview-content">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Word document preview - showing extracted text content
                    </div>
                    <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                        ${previewData.html || '<pre>' + escapeHtml(previewData.content || 'Content not available') + '</pre>'}
                    </div>
                </div>
            `;
            break;
            
        case 'pptx':
            previewBody.innerHTML = `
                <div class="preview-content text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        PowerPoint presentation - showing slide thumbnails
                    </div>
                    <div class="slides-preview">
                        ${previewData.slides ? previewData.slides.map((slide, index) => `
                            <div class="slide-thumbnail mb-3 p-3 border rounded">
                                <h6>Slide ${index + 1}</h6>
                                <div class="slide-content">${slide.content || 'No content preview available'}</div>
                            </div>
                        `).join('') : '<p>No slides preview available</p>'}
                    </div>
                </div>
            `;
            break;
            
        default:
            previewBody.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-file fa-3x text-secondary mb-3"></i>
                    <h5>Preview Not Available</h5>
                    <p class="text-muted">This file type cannot be previewed in the browser.</p>
                    <button class="btn btn-primary" onclick="downloadMaterial('${material.id}')">
                        <i class="fas fa-download me-2"></i>Download File
                    </button>
                </div>
            `;
    }
}

async function downloadMaterial(materialId) {
    const material = materialsData.find(m => m.id === materialId);
    if (!material) return;
    
    try {
        const link = document.createElement('a');
        link.href = `/api/download-file/${sessionId}?file=${encodeURIComponent(material.path)}`;
        link.download = material.name;
        link.click();
        
        // Update download count (optional)
        updateMaterialStats(materialId, 'download');
        
    } catch (error) {
        alert('Error downloading file: ' + error.message);
    }
}

function regenerateMaterial(materialId) {
    const material = materialsData.find(m => m.id === materialId);
    if (!material) return;
    
    // Show regeneration modal
    document.getElementById('regenerateItemName').textContent = material.name;
    const modal = new bootstrap.Modal(document.getElementById('regenerateModal'));
    modal.show();
    
    // Store current material for regeneration
    window.currentRegenerationMaterial = material;
}

async function confirmRegeneration() {
    const material = window.currentRegenerationMaterial;
    if (!material) return;
    
    const enhanceContent = document.getElementById('enhanceContent').checked;
    const keepOriginal = document.getElementById('keepOriginal').checked;
    
    // Hide confirmation modal and show progress modal
    bootstrap.Modal.getInstance(document.getElementById('regenerateModal')).hide();
    
    const progressModal = new bootstrap.Modal(document.getElementById('regenerationProgressModal'));
    document.getElementById('regenerationItemName').textContent = material.name;
    progressModal.show();
    
    try {
        // Start regeneration
        const response = await fetch('/api/regenerate-material', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: sessionId,
                material_id: material.id,
                enhance_content: enhanceContent,
                keep_original: keepOriginal
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Start listening for progress updates
            startRegenerationProgress(result.regeneration_id);
            
        } else {
            throw new Error('Failed to start regeneration');
        }
    } catch (error) {
        document.getElementById('regenerationStatus').textContent = 'Error: ' + error.message;
        document.getElementById('cancelRegenerationBtn').textContent = 'Close';
    }
}

function startRegenerationProgress(regenerationId) {
    if (regenerationEventSource) {
        regenerationEventSource.close();
    }
    
    regenerationEventSource = new EventSource(`/api/regeneration-progress/${regenerationId}`);
    
    regenerationEventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateRegenerationProgress(data);
    };
    
    regenerationEventSource.onerror = function() {
        document.getElementById('regenerationStatus').textContent = 'Connection error - please check status manually';
    };
}

function updateRegenerationProgress(data) {
    const progressBar = document.getElementById('regenerationProgress');
    const status = document.getElementById('regenerationStatus');
    
    progressBar.style.width = data.progress + '%';
    status.textContent = data.message;
    
    if (data.completed) {
        progressBar.style.width = '100%';
        status.textContent = 'Regeneration complete!';
        document.getElementById('cancelRegenerationBtn').textContent = 'Close';
        
        // Update material in local data
        const materialIndex = materialsData.findIndex(m => m.id === data.material_id);
        if (materialIndex !== -1) {
            materialsData[materialIndex] = { ...materialsData[materialIndex], ...data.updated_material };
        }
        
        // Refresh the current view
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('regenerationProgressModal')).hide();
            renderMaterials();
        }, 2000);
        
        if (regenerationEventSource) {
            regenerationEventSource.close();
        }
    } else if (data.error) {
        status.textContent = 'Error: ' + data.error;
        document.getElementById('cancelRegenerationBtn').textContent = 'Close';
        
        if (regenerationEventSource) {
            regenerationEventSource.close();
        }
    }
}

function cancelRegeneration() {
    if (regenerationEventSource) {
        regenerationEventSource.close();
    }
    
    // Cancel the regeneration process
    fetch(`/api/cancel-regeneration/${sessionId}`, { method: 'POST' });
    
    bootstrap.Modal.getInstance(document.getElementById('regenerationProgressModal')).hide();
}

// Bulk Actions
function bulkDownload() {
    if (selectedItems.size === 0) return;
    
    const selectedMaterials = Array.from(selectedItems).map(id => 
        materialsData.find(m => m.id === id)
    ).filter(m => m);
    
    // Create and submit form for bulk download
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/api/bulk-download/${sessionId}`;
    
    selectedMaterials.forEach(material => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'material_paths[]';
        input.value = material.path;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    // Clear selection
    selectedItems.clear();
    updateSelectedItemsUI();
    updateBulkActionsCard();
}

function bulkRegenerate() {
    if (selectedItems.size === 0) return;
    
    const count = selectedItems.size;
    if (confirm(`Are you sure you want to regenerate ${count} selected materials? This will replace the existing files.`)) {
        // Implementation for bulk regeneration
        alert('Bulk regeneration feature will be implemented');
    }
}

function bulkDelete() {
    if (selectedItems.size === 0) return;
    
    const count = selectedItems.size;
    if (confirm(`Are you sure you want to delete ${count} selected materials? This action cannot be undone.`)) {
        // Implementation for bulk deletion
        alert('Bulk deletion feature will be implemented');
    }
}

// Download Actions
function downloadAll() {
    window.location.href = `/api/download-all/${sessionId}`;
}

function selectiveDownload() {
    // Implement selective download modal
    alert('Selective download modal will be implemented');
}

function generateMoreMaterials() {
    if (confirm('This will redirect you to generate additional materials. Continue?')) {
        window.location.href = `/material-selection/${sessionId}`;
    }
}

function downloadCurrentPreview() {
    if (currentPreviewFile) {
        downloadMaterial(currentPreviewFile.id);
    }
}

function regenerateCurrentPreview() {
    if (currentPreviewFile) {
        bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
        regenerateMaterial(currentPreviewFile.id);
    }
}

// Utility Functions
function getFileIcon(format) {
    const icons = {
        'PDF': 'fas fa-file-pdf',
        'DOCX': 'fas fa-file-word',
        'PPTX': 'fas fa-file-powerpoint',
        'TXT': 'fas fa-file-alt',
        'default': 'fas fa-file'
    };
    return icons[format] || icons.default;
}

function getFileIconColor(format) {
    const colors = {
        'PDF': 'text-danger',
        'DOCX': 'text-primary',
        'PPTX': 'text-warning',
        'TXT': 'text-secondary',
        'default': 'text-muted'
    };
    return colors[format] || colors.default;
}

function getStatusClass(status) {
    const classes = {
        'completed': 'bg-success',
        'regenerated': 'bg-info',
        'error': 'bg-danger',
        'default': 'bg-secondary'
    };
    return classes[status] || classes.default;
}

function getTypeIcon(type) {
    const icons = {
        'Lecture Notes': 'fas fa-book',
        'Lecture Slides': 'fas fa-presentation',
        'Transcripts': 'fas fa-microphone',
        'Lab Materials': 'fas fa-flask',
        'Assessments': 'fas fa-tasks',
        'Seminar Materials': 'fas fa-users',
        'Module Overview': 'fas fa-info-circle',
        'Instructor Guide': 'fas fa-user-tie'
    };
    return icons[type] || 'fas fa-file';
}

function formatMaterialType(type) {
    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString() + ' ' + new Date(dateString).toLocaleTimeString();
}

function truncateText(text, maxLength) {
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateMaterialStats(materialId, action) {
    // Optional: track download/view statistics
    const material = materialsData.find(m => m.id === materialId);
    if (material) {
        material.stats = material.stats || {};
        material.stats[action] = (material.stats[action] || 0) + 1;
    }
}
</script>

<style>
.material-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.material-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.material-card.border-primary {
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.file-icon {
    opacity: 0.8;
}

.tree-week .week-header {
    transition: all 0.2s ease;
}

.tree-week .week-header:hover {
    background-color: #f8f9fa;
}

.material-item {
    transition: all 0.2s ease;
}

.material-item:hover {
    transform: translateX(5px);
}

.preview-content {
    max-height: 600px;
    overflow-y: auto;
}

.slide-thumbnail {
    background: #f8f9fa;
}

.selection-group {
    max-height: 300px;
    overflow-y: auto;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 2px;
    }
    
    .card-footer .btn-group {
        flex-direction: row;
    }
}

/* Enhanced table styling */
.table tbody tr:hover {
    background-color: rgba(0,123,255,0.1);
}

.table tbody tr.table-primary:hover {
    background-color: rgba(0,123,255,0.3);
}

/* Progress bar animations */
.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 0 0; }
    100% { background-position: 40px 0; }
}

/* Filter results badge animation */
.badge {
    transition: all 0.3s ease;
}

/* Tree view styling */
.tree-week {
    margin-left: 0;
}

.type-group {
    border-left: 3px solid #dee2e6;
    padding-left: 15px;
}

.materials-list .material-item {
    border-left: 2px solid transparent;
}

.materials-list .material-item:hover {
    border-left-color: #007bff;
}

/* Modal enhancements */
.modal-xl .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

/* Bulk actions card */
#bulkActionsCard {
    position: sticky;
    bottom: 20px;
    z-index: 1000;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>
{% endblock %}